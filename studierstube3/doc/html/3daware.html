<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="Author" content="Andreas Zajic">
   <meta name="GENERATOR" content="Mozilla/4.5 [en] (Win98; I) [Netscape]">
   <title>Creating a node</title>
</head>
<body>
<font face="Arial,Helvetica"><font size=+1>Creating a 3D
event handling node</font></font>
<p><font face="Arial,Helvetica">This tutorial describes the steps necessary
to make an Open Inventor node that is capable of handling 3D events. These
steps are illustrated with sample source code where the important parts
are printed in bold letters.</font>
<br>&nbsp;
<p><font face="Arial,Helvetica"><font size=+1>Creating an event aware node
requires the following steps:</font></font>
<p><font face="Arial,Helvetica">1. Derive a new node class according to
your needs.</font>
<br><font face="Arial,Helvetica">2. Add Base3D to the list of classes the
new class is derived from.</font>
<br><font face="Arial,Helvetica">3. Adding Base3D macros and include files
to the source code.</font>
<br><font face="Arial,Helvetica">4. Implement the handle3DEvent() method</font>
<br><font face="Arial,Helvetica">5. Implement the isInterested() method</font>
<br>&nbsp;
<p><font face="Arial,Helvetica"><font size=+1>Step 1 - Deriving a new node
class:</font></font>
<p><font face="Arial,Helvetica">The first step is to create a new subclass
from an existing scene graph node class. Creating a new subclass for event
handling nodes is done by using the same approach as for deriving new standard
node classes in Open Inventor. This includes defining fields for the node,
definition of an initClass() method, definition of a constructor, implementing
action behavior, etc. Everything about creating a new Open Inventor node
class is covered in detail by the <b>Open Inventor Toolmaker</b> (chapter
2: "Creating a Node").</font>
<br>&nbsp;
<p><font face="Arial,Helvetica"><font size=+1>Step 2 - Additional derivation
from Base3D:</font></font>
<p><font face="Arial,Helvetica">Now the just created node class has to
be made event aware. The first step to accomplish this task, is to add
the Base3D class to the new class' inheritance list. So the new subclass
is not only derived from an Open Inventor class, but also from Base3D.
Note that the Base3D class is not an Open Inventor class. It is only a
class that is used to add some functionality to a node class by using the
C++ derivation feature.</font>
<br>&nbsp;
<p><font face="Arial,Helvetica">sample source code (header file - SoDerivedNodeClass.h):</font>
<p><b><font face="Courier New,Courier"><font size=-1>#include &lt;Base3D.h></font></font></b>
<p><font face="Courier New,Courier"><font size=-1>class SoDerivedNodeClass:
public SoDerivedFromNodeClass, <b>public Base3D</b> {</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; SO_NODE_HEADER(SoDerivedNodeClass);</font></font>
<br><font face="Courier New,Courier"><font size=-1>public:</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; static
void initClass();</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; SoDerivedNodeClass();</font></font>
<br><font face="Courier New,Courier"><font size=-1>protected:</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; virtual
~SoDerivedNodeClass();</font></font>
<br><font face="Courier New,Courier"><font size=-1>}</font></font>
<br>&nbsp;
<p><font face="Arial,Helvetica"><font size=+1>Step 3 - Using macros and
include files:</font></font><font face="Arial,Helvetica"></font>
<p><font face="Arial,Helvetica">Similar to the standard node class creation,
macros are used for initialization purposes. Base3D includes four macros
for defining the event handling parts of the new class: BASE3D_CONSTRUCTOR,
BASE3D_INIT_CLASS(), BASE3D_HEADER, BASE3D_SOURCE().</font>
<br><font face="Arial,Helvetica">Along with the macros two include files
have to be added to the program: So3DEvent.h and SoHandle3DEventAction.h.</font><font face="Arial,Helvetica"></font>
<p><font face="Arial,Helvetica">The sample source code below show where
the Base3D macros must be added to assure the correct initialization of
the event handling portions of the new node class.</font>
<p><font face="Arial,Helvetica"><font size=-1>Note: When adding the Base3D
macros it is important that you insert them <b>after</b> the corresponding
Open Inventor macros which are used for node creation.</font></font>
<p><font face="Arial,Helvetica">sample source code (header file - SoDerivedNodeClass.h)</font>
<br>&nbsp;
<blockquote><font face="Courier New,Courier"><font size=-1>#include &lt;Base3D.h></font></font>
<p><font face="Courier New,Courier"><font size=-1>class SoDerivedNodeClass:
public SoDerivedFromNodeClass, public Base3D {</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; SO_NODE_HEADER(SoDerivedNodeClass);</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; <b>BASE3D_HEADER;</b></font></font>
<br><font face="Courier New,Courier"><font size=-1>public:</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; static
void initClass();</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; SoDerivedNodeClass();</font></font>
<br><font face="Courier New,Courier"><font size=-1>protected:</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; virtual
~SoDerivedNodeClass();</font></font>
<br><font face="Courier New,Courier"><font size=-1>}</font></font></blockquote>
<font face="Arial,Helvetica">sample source code (implementation file -
SoDerivedNodeClass.cxx):</font>
<br>&nbsp;
<blockquote><font face="Courier New,Courier"><font size=-1>#include "SoDerivedNodeClass.h"</font></font>
<p><b><font face="Courier New,Courier"><font size=-1>#include "So3DEvent.h"</font></font></b>
<br><b><font face="Courier New,Courier"><font size=-1>#include "SoHandle3DEventAction.h"</font></font></b>
<p><font face="Courier New,Courier"><font size=-1>SO_NODE_SOURCE(SoDerivedNodeClass);</font></font>
<p><b><font face="Courier New,Courier"><font size=-1>BASE3D_SOURCE(SoDerivedNodeClass);</font></font></b>
<p><font face="Courier New,Courier"><font size=-1>void SoDerivedNodeClass::initClass()
{</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; SO_NODE_INIT_CLASS(SoDerivedNodeClass,
SoDerivedFromNodeClass, "name");</font></font>
<p><b><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;
BASE3D_INIT_CLASS(SoDerivedNodeClass);</font></font></b>
<br><font face="Courier New,Courier"><font size=-1>}</font></font>
<p><font face="Courier New,Courier"><font size=-1>SoDerivedNodeClass::SoDerivedNodeClass()
{</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; SO_NODE_CONSTRUCTOR(SoDerivedNodeClass);</font></font>
<p><b><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;
BASE3D_CONSTRUCTOR;</font></font></b>
<br><font face="Courier New,Courier"><font size=-1>}</font></font></blockquote>
<font face="Arial,Helvetica"><font size=+1></font></font>
<p><br><font face="Arial,Helvetica"><font size=+1>Step 4 - Handling 3D
events - implementation of the handle3DEvent() method:</font></font>
<p><font face="Arial,Helvetica">Now the newly created class is aware of
3D events, but by default it does not handle these events although they
are passed to the handle3DEvent() method. Since the default implementation
of this method is to do nothing upon reception of an event, it has to be
overwritten to support unique event handling by the node class.</font><font face="Arial,Helvetica"></font>
<p><font face="Arial,Helvetica">Below is a sample of a handle3DEvent()
method that could be used by a pushbutton node class that reacts to button
events (the example includes some pseudo code fragments as comments).</font><font face="Arial,Helvetica"></font>
<p><font face="Arial,Helvetica">sample source code of a handle3DEvent()
method that could be used by a pushbutton node:</font>
<blockquote><font face="Courier New,Courier"><font size=-1>void SoPushButton::handle3DEvent(SoHandle3DEventAction
*h3a) {</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; So3DEvent
*event = (So3DEvent*)h3a->getEvent();</font></font>
<p><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; if
(event->getStation()==0) {</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
switch(event->getType()) {</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case So3DEvent::ET_BUTTON1_EVENT:</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
switch(event->getButton(So3DEvent::BUTTON1)) {</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case TRUE:</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
h3a->setGrabber(this);</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* BUTTON STATE = PUSHED */</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case FALSE:</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if(h3a->getGrabber()==this) {</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
h3a->releaseGrabber();</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (/* BUTTON STATE == PUSHED */) {</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* NOW THE BUTTON WAS PUSHED - IMPLEMENT REACTION HERE */</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* BUTTON STATE = RELEASED */</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
default:</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case So3DEvent::ET_MOVE_EVENT:</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (h3a->getGrabber()==this) {</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (isInterested(h3a)==FALSE)</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* BUTTON STATE = RELEASED */</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
else</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* BUTTON STATE = PUSHED */</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
default:</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; }</font></font>
<br><font face="Courier New,Courier"><font size=-1>}</font></font></blockquote>
<font face="Arial,Helvetica"><font size=+1>Step 5 - Where did the event
occur - implementation of the isInterested() method:</font></font><font face="Arial,Helvetica"></font>
<p><font face="Arial,Helvetica">The new event aware node class is now ready
to handle incoming events from the 3D event system. Before calling the
handle3DEvent() method the isInterested() method is called to determine
wether the node is interested in getting the current event passed to its
handle3DEvent() method or not. By default the isInterested method is implemented
as a two step bounding box test (axis aligned and transformed) to see if
the event occured inside the nodes geometry. When implementing new node
classes it could be useful to overwrite this method to get more accurate
testing of the position where the event occured and the geometry. Aside
from the position of the event other test algorithms could be used to determine
wether there is interest in an event or not.</font><font face="Arial,Helvetica"></font>
<p><font face="Arial,Helvetica">default implementation of the isInterested()
method:</font>
<br>&nbsp;
<blockquote><font face="Courier New,Courier"><font size=-1>SbBool Base3D::isInterested(SoHandle3DEventAction
*h3a) {</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; So3DEvent
*ev = (So3DEvent*)h3a->getEvent();</font></font>
<p><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; const
SoPath *currPath = h3a->getPathFromRoot();</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; static
SbViewportRegion vp;</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; static
SoGetBoundingBoxAction *bba=new SoGetBoundingBoxAction(vp);</font></font>
<p><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; bba->apply((SoFullPath*)currPath);</font></font>
<p><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; SbBox3f
box=bba->getBoundingBox();</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; if
(box.intersect(ev->getTranslation())==FALSE) {</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return FALSE;</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; }</font></font>
<p><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; SbXfBox3f
xfbox=bba->getXfBoundingBox();</font></font>
<p><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; if(xfbox.intersect(ev->getTranslation())==FALSE)
{</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return FALSE;</font></font>
<br><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; }</font></font>
<p><font face="Courier New,Courier"><font size=-1>&nbsp;&nbsp;&nbsp; return
TRUE;</font></font>
<br><font face="Courier New,Courier"><font size=-1>}</font></font></blockquote>

<hr>
<!-- cg-maintained-by user=zajic -->
<small>
This page is maintained by <b>Andreas Zajic Diplomand ALF</b>. It was last updated on <b>August 18, 1999</b>.<br>
If you have any comments, please send a message to <a href="mailto:zajic@cg.tuwien.ac.at">zajic@cg.tuwien.ac.at</a>.
</small>
<!-- /cg-maintained-by -->
</body>
</html>
