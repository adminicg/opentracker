<html>
<!-- #BeginTemplate "/Templates/master.dwt" -->
<head>
<!-- #BeginEditable "doctitle" -->
<title>Studierstube Augmented Reality Project</title>
<!-- #EndEditable -->
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="../stb.css" type="text/css">
</head>
<body bgcolor="#FFFFFF" text="#000000">
<table border="0" cellspacing="0" cellpadding="0" width="100%">
    <tr>
        <td background="http://www.studierstube.org/media/images/studierstube_header_background.gif">
            <table border="0" cellpadding="0" cellspacing="0">
                <tr>
                    <td><a href="/index.html"><img src="http://www.studierstube.org/media/images/studierstube_header_logo.gif" width="100" height="100" vspace="15" hspace="15" border="0"></a></td>
                    <td>
                        <h1>Studierstube Augmented Reality Project</h1>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
    <tr>
        <td background="/media/images/studierstube_dots_horiz.gif" style="background-repeat:repeat-x"><img src="/media/images/spacer.gif" width="100%" height="1"></td>
    </tr>
    <tr>
        <td align="right" bgcolor="#F6F6F6">
            <table border="0" cellpadding="0" cellspacing="0">
                <tr>
                    <td background="/media/images/studierstube_dots_vert.gif"><img src="/media/images/spacer.gif" width="1" height="20"></td>
                    <td>&nbsp;</td>
                    <td>&nbsp;<a href="/index.html" class="navMain">Home</a>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td background="/media/images/studierstube_dots_vert.gif"><img src="/media/images/spacer.gif" width="1" height="20"></td>
                    <td>&nbsp;</td>
                    <td>&nbsp;<a href="/research_master.php" class="navMain">Research</a>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td background="/media/images/studierstube_dots_vert.gif"><img src="/media/images/spacer.gif" width="1" height="20"></td>
                    <td>&nbsp;</td>
                    <td>&nbsp;<a href="/developer.html" class="navMain">Development</a>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td background="/media/images/studierstube_dots_vert.gif"><img src="/media/images/spacer.gif" width="1" height="20"></td>
                    <td>&nbsp;</td>
                    <td>&nbsp;<a href="/projects.html" class="navMain">Projects</a>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td background="/media/images/studierstube_dots_vert.gif"><img src="/media/images/spacer.gif" width="1" height="20"></td>
                    <td>&nbsp;</td>
                    <td>&nbsp;<a href="/search/index.php3" class="navMain">Search</a>&nbsp;</td>
                    <td>&nbsp;</td>
                </tr>
            </table>
        </td>
    </tr>
    <tr>
        <td colspan="2" background="/media/images/studierstube_dots_horiz.gif" style="background-repeat:repeat-x"><img src="/media/images/spacer.gif" width="100%" height="1"></td>
    </tr>
</table>
<table border="0" cellspacing="0" cellpadding="15">
    <tr>
        <td><img src="/media/images/spacer.gif" width="1" height="1"></td>
    </tr>
    <tr>

    <td><!-- #BeginEditable "content" -->
      <h1 align="center">ARToolkit vs. Studierstube</h1>
      <p>This document shows how to use the ARToolkit as input library for Studierstube
        applications. As this is done vie OpenTracker, you will need to compile
        the Studierstube with support for this library. See the <a href="opentracker_integration.html">Studierstube
        vs. OpenTracker</a> guide for details on that.</p>
      <h2> 1. Using ARToolkit in OpenTracker</h2>
      <p> ARToolkit is a library that scans video images for known optical markers
        and computes the pose of the markers with respect to the camera. OpenTracker
        supports this library and allows to use it as a source of tracking data.
        The following description explains how to configure OpenTracker to use
        this feature.</p>
      <p> The starting point for data generated by the ARToolkit library is the
        <b>ARToolKitSource</b> node. Exactly one node must be specified for each
        marker of interest. The following code is an example of such an <b>ARToolKitSource</b>
        node :</p>
      <pre>
&lt;ARToolKitSource tag-file=&quot;pip.tag&quot; center=&quot;0 0&quot; size=&quot;40&quot; /&gt;
</pre>
      <p> The attribute <b>tag-file</b> declares the file that stores the image
        data of the marker (these are generated by the ARToolkit tool mk_patt.exe).
        <b>center</b> defines the origin of the marker with respect to the image
        in millimeters and is 0 0 by default (the mid point of the image). Finally
        <b>size</b> defines the dimension of the quadratic marker in millimeters.</p>
      <p> The output of such a node corresponds to a rather confusing coordinate
        system. To get usable data, it should be transformed by an EventTransform
        node in the following way.</p>
      <pre>
&lt;EventTransform rotation=&quot;1 0 0 0&quot; scale=&quot;0.001 0.001 0.001&quot;&gt;
  &lt;ARToolKitSource tag-file=&quot;data/pen1.tag&quot; center=&quot;0 0&quot; size=&quot;50 50&quot;/&gt;
&lt;/EventTransform&gt;
</pre>
      <p> This transformation generates tracking data corresponding to the following
        coordinate system </p>
      <p align="center"><img src="../images/artcoords.gif" width="466" height="213"></p>
      <center>
        <p align="CENTER"><i>Figure 1: Camera coordinate system and marker pose</i></p>
      </center>
      <p> The origin of the measurement coordinate system lies in the camera and
        the optical axis points in the direction of -Z. The Y axis points upwards.
        A marker that lies parallel to the image plane and that is not rotated
        around the optical axis has as rotation the identity rotation. This coordinate
        system matches a perspective Studierstube viewer which is in its default
        position and orientation. In this case the pose of the virtual camera
        corresponds to the pose of the real camera. However, the focus is not
        the same.</p>
      <p> A simple configuration of a station using an optical marker looks like
        this :</p>
      <pre>
&lt;StbSink station=&quot;4&quot; event=&quot;on&quot;&gt;
    &lt;EventTransform scale=&quot;0.001 0.001 0.001&quot; rotation=&quot;1 0 0 0&quot;&gt;
        &lt;ARToolKitSource center=&quot;0 0&quot; size=&quot;50 50&quot; tag-file=&quot;data/pi.patt&quot;/&gt;
    &lt;/EventTransform&gt;
&lt;/StbSink&gt;
</pre>
      <p> In this example the pose of the marker defined in the file pi.patt is
        transformed according to the above description. Then it is relayed to
        the Studierstube as <i>station</i> 4 using a <b>StbSink</b> node.</p>
      <h2> 2. Using Tracking Data within the Studierstube</h2>
      <p> The Studierstube supplies applications with tracking data either through
        global fields and additionally with 3D events for all configured stations.
        To simplify using this data several nodes are supplied that work with
        it. Using these nodes in scripted OpenInventor files or by instatiating
        them in the applications speeds up implementation.</p>
      <h3> 3.1 SoTrackedArtifactKit</h3>
      <p> A <b>SoTrackedArtifactKit</b> is a simple node, that moves a sub scene
        graph according to tracking data of a <i>station</i>. It uses the <i>global
        fields</i> associated with the <i>station</i>. The following code shows
        how to use this node :</p>
      <pre>
SoTrackedArtifactKit {
    station 6
    geometry Separator {
        Material { diffuseColor 1 0 0 }
        Sphere { radius 0.1 }
    }
}
</pre>
      <p> This node has to interesting fields. The field <b>station</b> declares
        the number of the <i>station</i> to use. The field <b>geometry</b> is
        an arbitrary OpenInventor node that stores the sub scene graph that is
        moved. Typically a Group or Separator node is used here. In this example
        a red sphere is declared and it is moved by the tracking data received
        from <i>station</i> 6. </p>
      <h3> 3.2 SoStationKit</h3>
      <p> The <b>SoStationKit</b> is more complex. It only deals with 3D events,
        therefore all <i>stations</i> that are used by such a node have to generate
        3D events (see the <b>StbSink</b> node of OpenTracker above). It can be
        configured to accept move events from any number of tracker station (in
        our case, ARToolKit markers). It has the following important features:</p>
      <ul>
        <li> All behavior (except user defined callbacks) can be scripted in .iv
          files without C++ coding.
        <li> Can process information from a set of <i>stations</i>.
        <li> In its simplest form, it processed information from a single station,
          which is used to move around a virtual object. The virtual object is
          an arbitrary scene graph that is specified by the user. This scene graph
          is optional, its automatic movement from the tracker information can
          be turned off and it can also be set invisible at any time.
        <li> If a physical object is fitted with multiple stations (e. g., to
          avoid occlusion problems), the stations?geometric relationships to each
          other and the physical object can be conveniently expressed. The node
          computes a final transformation of the physical object, which can again
          be used to move a virtual object.
        <li> Using of multiple stations is particularly convenient for determining
          the relative position of *large* objects such as a library or even building.
          In these cases not the objects, but the user moves. However, the problem
          remains the same, as a virtual model (e.g. for a library) that augmented
          the physical environment must only be moved relative to the user. We
          do *not* use the user (i. e., the virtual camera), but rather the ?world&quot;
          (scene) that surrounds the user.
        <li> Station recording: The last event received from a particular (where
          and when) is automatically recorded. Useful if one needs to determine
          relative
        <li> Timeout: If no information is received from any configured station
          for a specified time, a virtual object is made invisible and a user
          callback is called.
        <li> User supplied callbacks can be executed every time a 3D event is
          received. This opens up a wide range of interaction possibilities decribed
          below.
      </ul>
      <p> A <b>SoStationKit</b> node has the following fields :</p>
      <dl>
        <dt> <strong>stations</strong>
        <dd> A list of integers defining the <i>stations</i> to be used by the
          node.
        <dt> <strong>stationPosition</strong>
        <dd> A list of vectors describing the offset of each <i>station</i> to
          the virtual object. An entry in this list corresponds to the <i>station</i>
          in the same position in the list of <i>stations</i> in the field <b>stations</b>.
        <dt> <strong>stationOrientation</strong>
        <dd> A list of rotations describing the rotational offset of each <i>station</i>
          to the virtual object. The order is the same as for the field <b>stationPosition</b>.
        <dt> <code><b>currentPosition</b></code>
        <dd> A list of vectors giving the last position of each <i>station</i>.
          The order is the same as for the field <b>stationPosition</b>.
        <dt> <code><b>currentOrientation</b></code>
        <dd> A list of rotations giving the last orientation of each <i>station</i>.
          The order is the same as for the field <b>stationPosition</b>.
        <dt> <code><b>lastEvent</b></code>
        <dd> This list of time values stores the time stamps for the last events
          received for each <i>station</i>. The order is the same as for the field
          <b>stationPosition</b>.
        <dt> <strong>position</strong>
        <dd> This vector stores the current position of the virtual object. It
          is computed from the last received 3D event and the offsets of the corresponding
          station as stored in <strong>stationPosition</strong> and <strong>stationPosition</strong>.
        <dt> <strong>orientation</strong>
        <dd> This rotation stores the current orientation of the virtual object.
          It is computed from the last received 3D event and the offsets of the
          corresponding station as stored in <strong>stationPosition</strong>
          and <strong>stationPosition</strong>.
        <dt> <code><b>timeOut</b></code>
        <dd> This time value is the duration of the visibility timeout. If no
          event is received during the given duration, the object is set to invisible.
          If the <b>timeOut</b> is 0 the object will always stay visible.
        <dt> <strong>visible</strong>
        <dd> This flag defines if the object is visible or not.
        <dt> <strong>transformUpdate</strong>
        <dd> This flag defines if the pose of the object is actually updated from
          the fields <b>position</b> and <strong>orientation</strong> or not.
      </dl>
      <p> Moreover there are two call back function types available. Registered
        StationEventCB functions are called as soon as a new event is processed.
        Registered StationTimeoutCB are called when a visiblity timout occured.
        See the online documentation of the Studierstube for details on the API.</p>
      <p> So what can be done with this node, in particular using the callbacks?</p>
      <ul>
        <li> Slave movement of a virtual object, with single station (mentioned
          above): Just configure one station and supply a scene graph
        <li> Slave movement with multiple stations: Just configure multiple stations
          and supply a scene graph
        <li> User moves in a room or building: Same case as above, only the object
          is very big. (Note that we are also currently designing an extended
          version of the node that can handle very large models partitioned into
          rooms, where stations can be recycled in every room.)
        <li> Detection of movement of multiple stations, for example proximity
          detector: For example, you can detect if station A is next to station
          B by setting a callback where you look for events of station A If any
          occurs, check whether the recorded position of B is sufficiently close,
          and whether the recorded timestamp of B is the same as for A ? then
          A is next to B.
        <li> Constrained movement: Sometime you do not want direct slave movement
          of a virtual object according to some station. For example, you may
          want to move object_A with station_A, but only up to x &lt;= 2m. When
          station_A is moved to the right of the 2m boundary, object_A should
          remain where it was. Then you disable the ?transformUpdate&quot; feature
          (i. e., slave movement) and set a callback that manually computes the
          virtual objects position from the station?s event according to your
          algorithm.
      </ul>
      <p> The following is example code for a <b>SoStationKit</b> :</p>
      <pre>
SoStationKit {
    stations [4,5]
    stationPosition [0 -0.05 0, 0 0.05 0]
    stationOrientation [1 0 0 1.570796 , 1 0 0 -1.570796]
    timeOut 10
    content SoGroup {
        Transform { translation 0 0.05 0 }
        Material { diffuseColor 0 0 1 }
        Cube { width 0.1 height 0.05 depth 0.1 }
        Transform { translation 0 -0.05 0 }
        Material { diffuseColor 0 1 0 }
        Cube { width 0.1 height 0.05 depth 0.1 }
    }
}
</pre>
      <p> This <b>SoStationKit</b> controls a virtual cube which is half blue
        and half green. It is controlled using two markers using <i>stations</i>
        4 and 5. The marker corresponding to <i>station</i> 4 is fixed to the
        green half and the other one to the blue half. This is defined in the
        offsets corresponding to the two <i>stations</i>. </p>
      <h3> 3.3 SoPartitionKit</h3>
      <p> Another node to manage <b>SoStationKit</b> nodes is the <b>SoPartitionKit</b>
        node. It solves the following problem : If a large number of optical markers
        are used in an environment, it is sensible to reuse the markers in different
        locations. For example rooms that are distant enough can be augmented
        with the same set of markers. Each room can be represented by a <b>SoStationKit</b>
        and the stations that are associated with the markers. However it is necessary
        to know which SoStationKit corresponds to the current real room the user
        is in. To switch to the next correct room, if the user is walking from
        one to the next, it is also necessary to use unique sets of markers for
        each neighboring room. The correct switching and enabling of <b>SoStationKits</b>
        is dealt with by the <b>SoParitionKit</b> node.</p>
      <p> There are five rooms A to E present in the following example. Only rooms
        A and E may use the same set of markers, because there is no common neighbor
        room to both rooms. In total, we can use four unique sets of markers to
        fit the five rooms</p>
      <p align="center">&nbsp;</p>
      <p align="center"><img src="../images/rooms.gif" width="470" height="265"></p>
      <center>
        <p align="CENTER"><i>Figure 2: The five rooms and corresponding adjacency
          graph</i></p>
      </center>
      <p> To make event processing efficient, only <b>SoStationKits</b> that are
        of interest should process 3D events. Therefore only the room representing
        the users current location and its neighboring rooms should deal with
        events.</p>
      <p> This is all managed by the SoParitionKit. It has the following fields
        :</p>
      <dl>
        <dt> <strong>activeChild</strong>
        <dd> An integer denoting the currently active <b>SoStationKit</b>. This
          <b>SoStationKit</b> is always visible. Its neighboring nodekits (as
          defined by the portals field) can process 3D events but are not visible.
          All other kits are invisible and receive no events.
        <dt> <strong>portals</strong>
        <dd> A list of integers, that describes the neighbor nodekits for each
          <b>SoStationKit</b>. This defines the adjacency graph of the <b>SoStationKits</b>.
          First all neighbors for kit 0 are listed, then all neighbors for kit
          1 and so on. The number of neighbors for each kit is stored in the numPortals
          field.
        <dt> <strong>numPortals</strong>
        <dd> A list of integers, that describes the number of neighbors for each
          <b>SoStationKit</b>.
        <dt> <strong>stationKits</strong>
        <dd> This part is a <b>SoMultiSwitch</b> that contains the <b>SoStationKits</b>
          for the individual rooms. These <b>SoStationKits</b> need not appear
          as direct children of the <b>SoMultiSwitch</b> but each subgraph defined
          by a child is search for the first <b>SoStationKit</b>. This is then
          used as the <b>SoStationKit</b> related to that child. This allows to
          specify transformations between the <b>SoPartitionKit</b> and an <b>SoStationKit</b>.
      </dl>
      <p> The following code defines a SoPartitionKit for the example above:</p>
      <pre>
SoPartitionKit {
  activeChild 1      # start in B
  numPortals [ 1, 3, 3, 2, 1 ]
  portals [ 1,       # A
            0, 2, 3, # B
            1, 3, 4, # C
            1, 2,    # D
            2 ]      # E

  stationKits SoMultiSwitch {
    DEF A SoStationKit { ... }
    DEF B SoStationKit { ... }
    Transform {
      translation 0 1 0
      DEF C SoStationKit { ... }    # is used by the SoPartitionKit as well !
    }
    DEF D SoStationKit { ... }
    DEF E SoStationKit { ... }
  }
}</pre>
      <p align="center">&nbsp;</p>
      <p>&nbsp;</p>
      <!-- #EndEditable --></td>
    </tr>
    <tr>
        <td><img src="/media/images/spacer.gif" width="1" height="1"></td>
    </tr>
</table>
<table border="0" cellspacing="0" cellpadding="0" width="100%">
    <tr>
        <td colspan="3" background="/media/images/studierstube_dots_horiz.gif" style="background-repeat:repeat-x"><img src="/media/images/spacer.gif" width="100%" height="1"></td>
    </tr>
    <tr>
        <td bgcolor="#F6F6F6">&nbsp; <a href="mailto:reitmayr@studierstube.org" class="navMain">Webmaster</a></td>
        <td bgcolor="#F6F6F6"><img src="/media/images/spacer.gif" width="1" height="20"></td>
        <td bgcolor="#F6F6F6" align="right"><a href="http://www.studierstube.org/" class="navMainCopyright">www.studierstube.org</a>
            &nbsp;</td>
    </tr>
    <tr>
        <td colspan="3" background="/media/images/studierstube_dots_horiz.gif" style="background-repeat:repeat-x"><img src="/media/images/spacer.gif" width="100%" height="1"></td>
    </tr>
</table>
</body>
<!-- #EndTemplate -->
</html>
